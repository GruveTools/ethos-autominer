#!/usr/bin/env php
<?php
	/**
	 * This script adapted by Japh
	 *
	 * Original code by AllCrypto https://www.youtube.com/watch?v=vf0doK-j54g and http://textuploader.com/dl3w5
	 */

	$dry_run = ($argv[1] == '--dry-run' ? true : false);

	echo ($dry_run ? "Dry run in progress...\r\n" : '');

	// Switch to the ethos home directory
	if(!$dry_run) {
		chdir('/home/ethos/');
	}

	// If there's no scripts directory, make one
	if(!file_exists('scripts')) {
		mkdir('scripts');
	}
	// If there's no configs directory, make one. (Though obviously no configs directory means no configs, so we won't get far.)
	if(!file_exists('configs')) {
		mkdir('configs');
	}

	// Get the current hour
	$hour = date('H', time());

	// Config files for all algos we'd like to allow switching between
	$coins = false;
	if(!file_exists('config.php')) {
		echo "Missing a config.php file, please use the config.sample.php file as a template.\r\n";
		return false;
	}
	require_once('config.php');

	// Check there's no no-autoswitch file in the scripts directory, manually creating this file will stop switching
	if(!file_exists('scripts/no-autoswitch'))
	{
		// Get current profitability from whattomine, still not sure if the querystring parameters are used
		$json_coins = file_get_contents('http://whattomine.com/coins.json?utf8=%E2%9C%93&adapt_q_280x=0&adapt_q_380=0&adapt_q_fury=0&adapt_q_470=0&adapt_q_480=3&adapt_q_570=0&adapt_q_580=0&adapt_q_750Ti=0&adapt_q_1050Ti=0&adapt_q_10606=0&adapt_q_1070=6&adapt_1070=true&adapt_q_1080=0&adapt_q_1080Ti=0&eth=true&factor%5Beth_hr%5D=180.0&factor%5Beth_p%5D=720.0&grof=true&factor%5Bgro_hr%5D=213.0&factor%5Bgro_p%5D=780.0&x11gf=true&factor%5Bx11g_hr%5D=69.0&factor%5Bx11g_p%5D=720.0&cn=true&factor%5Bcn_hr%5D=3000.0&factor%5Bcn_p%5D=600.0&eq=true&factor%5Beq_hr%5D=2580.0&factor%5Beq_p%5D=720.0&lre=true&factor%5Blrev2_hr%5D=213000.0&factor%5Blrev2_p%5D=780.0&ns=true&factor%5Bns_hr%5D=6300.0&factor%5Bns_p%5D=930.0&lbry=true&factor%5Blbry_hr%5D=1620.0&factor%5Blbry_p%5D=720.0&bk2bf=true&factor%5Bbk2b_hr%5D=9600.0&factor%5Bbk2b_p%5D=720.0&bk14=true&factor%5Bbk14_hr%5D=15000.0&factor%5Bbk14_p%5D=750.0&pas=true&factor%5Bpas_hr%5D=5640.0&factor%5Bpas_p%5D=720.0&skh=true&factor%5Bskh_hr%5D=159.0&factor%5Bskh_p%5D=720.0&factor%5Bl2z_hr%5D=420.0&factor%5Bl2z_p%5D=300.0&factor%5Bcost%5D=0.16&sort=Profitability24&volume=0&revenue=24h&factor%5Bexchanges%5D%5B%5D=&factor%5Bexchanges%5D%5B%5D=bittrex&factor%5Bexchanges%5D%5B%5D=bleutrade&factor%5Bexchanges%5D%5B%5D=cryptopia&factor%5Bexchanges%5D%5B%5D=hitbtc&factor%5Bexchanges%5D%5B%5D=poloniex&factor%5Bexchanges%5D%5B%5D=yobit&dataset=Main&commit=Calculate');
		$data_coins = json_decode($json_coins, true);
		$profits = false;

		if(isset($data_coins['coins']) && count($data_coins['coins']) > 0)
		{
			// Run through all coins returned by whattomine and get profitability of ones we're interested in
			foreach($data_coins['coins'] as $label => $coin)
			{
				if(!isset($coins[$coin['tag']]))
					continue; // Skip unsupported coins.
				if($coin['lagging'])
					continue; // Skip lagging coins.

				$tag = $coin['tag'];
				$hash_rate = $coins[$tag]['hash_rate'];
				$coin_id = $coin['id'];

				$profits[$tag] = floatval($coin['profitability']);

				/// Looks like the original author had plans to go deeper...
				//$json_coin = file_get_contents("http://whattomine.com/coins/$coin_id.json?hr=$hash_rate&p=0&fee=0.0&cost=0&hcost=0.0");
				//$data_coin = json_decode($json_coin, true);
				//$profits[$tag] = floatval($data_coin['btc_revenue']); // str_replace('$', '', $data_coin['revenue'])
			}
		}

		// Output list
		echo "Profits:\r\n";
		foreach($profits as $label => $profit) {
			echo "  " . $label . " -> " . $profit . "\r\n";
		}

		if($profits && count($profits) > 0)
		{
			// Sort by profit (reverse)
			uasort($profits, 'float_rsort');
			$new_coin = key($profits);
			$new_profit = current($profits);

			// Get current active coin
			$current_coin = '';
			if (file_exists('scripts/current_coin.txt')) {
				$current_coin = file_get_contents('scripts/current_coin.txt');
			}
			if($new_coin == $current_coin)
				return;

			// Switch coin
			file_put_contents('scripts/current_coin.txt', $new_coin, LOCK_EX);
			$output = '';
			if(!$dry_run) {
				$config_file = $coins[$new_coin]['config'];
				copy("configs/".$config_file, "local.conf");
				sleep(5);
				$output += shell_exec('/opt/ethos/bin/disallow 2>&1');
				sleep(5);
				$output += shell_exec('/opt/ethos/bin/restart-proxy 2>&1');
				sleep(5);
				$output +=shell_exec('/opt/ethos/bin/allow 2>&1');
				sleep(5);
			} else {
				$output += 'DRY RUN';
			}
			file_put_contents('scripts/switcher.log', date('m/d/Y H:i:s')." - Switching to $new_coin ($new_profit): $output.\r\n", FILE_APPEND | LOCK_EX);
		}
	}

	// Function for reverse order sorting
	function float_rsort($a, $b) {
		if ($a == $b) {
			return 0;
		}
		return ($a > $b) ? -1 : 1;
	}
